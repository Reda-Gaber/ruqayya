<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>لوحة التحكم - مؤسسة رقية اليامي للمقاولات</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
  <style>
    :root { --primary: #1bade2; --primary-dark: #1bade2; --success: #27ae60; --danger: #e74c3c; }
    body { font-family: 'Cairo', sans-serif; background: #f8f9fa; min-height: 100vh; }
    .sidebar { position: fixed; top: 0; bottom: 0; right: 0; width: 280px; background: #1bade2; color: white; z-index: 1000; padding-top: 2rem; box-shadow: -10px 0 30px rgba(0,0,0,0.1); overflow-y: auto; display: flex; flex-direction: column; }
    .sidebar .logo { font-size: 1.6rem; font-weight: 900; text-align: center; margin-bottom: 3rem; }
    .sidebar a { color: rgba(255,255,255,0.9); padding: 1rem 1.5rem; display: block; transition: all 0.3s; border-right: 4px solid transparent; }
    .sidebar a:hover, .sidebar a.active { background: rgba(255,255,255,0.15); border-right-color: white; color: white; }
    .main-content { margin-right: 280px; padding: 2rem; }
    .section { display: none; }
    .section.active { display: block; animation: fadeIn 0.5s; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .card { border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); overflow: hidden; }
    .project-img { height: 180px; object-fit: cover; border-radius: 15px 15px 0 0; }
    .image-preview img { height: 120px; object-fit: cover; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
    @media (max-width: 992px) {
      .sidebar { width: 100%; height: auto; position: relative; padding-top: 1rem; }
      .main-content { margin-right: 0; padding: 1rem; }
      .sidebar a { display: inline-block; margin: 0.5rem; border-radius: 50px; }
    }
    .sidebar a { text-decoration: none !important;}
  </style>
</head>
<body>

  <!-- Sidebar -->
  <div class="sidebar">
    <div class="logo text-white">
      <i class="fas fa-hard-hat fa-2x d-block mb-2"></i>
      رقية اليامي
    </div>
    <a href="#" data-section="projects" class="active"><i class="fas fa-th-large"></i> المشاريع</a>
    <a href="#" data-section="add-project"><i class="fas fa-plus-circle"></i> إضافة مشروع</a>
    <a href="#" data-section="news"><i class="fas fa-newspaper"></i> الأخبار</a>
    <a href="#" data-section="add-news"><i class="fas fa-plus-square"></i> إضافة خبر</a>
    <a href="#" data-section="employees"><i class="fas fa-users"></i> الموظفين</a>
    <a href="/admin/logout" class="text-danger mt-4"><i class="fas fa-sign-out-alt"></i> تسجيل الخروج</a>
  </div>

  <div class="main-content">

    <!-- قسم المشاريع مع عرض المراحل -->
    <div id="projects" class="section active">
      <h2 class="text-primary mb-4"><i class="fas fa-project-diagram"></i> جميع المشاريع</h2>
      <div class="row g-4" id="projects-container">
        <% if (projects && projects.length > 0) { %>
          <% projects.forEach(p => { %>
            <div class="col-md-6 col-lg-4 col-xxl-3">
              <div class="card h-100">
                <img src="<%= p.mainImage || '/images/default.jpg' %>" class="project-img w-100" alt="<%= p.title %>">
                <div class="card-body d-flex flex-column">
                  <h5 class="card-title mb-2"><%= p.title %></h5>
                  <span class="badge bg-primary mb-3"><%= p.category || 'غير محدد' %></span>
                  <p class="text-muted small flex-grow-1 mb-3"><%= p.description.substring(0,100) %>...</p>

                  <!-- <% if (p.stages && p.stages.length > 0) { %>
                    <div class="mb-3">
                      <h6 class="text-success mb-2"><i class="fas fa-tasks"></i> مراحل التنفيذ (<%= p.stages.length %>)</h6>
                      <div class="row g-2">
                        <% p.stages.forEach(stage => { %>
                          <div class="col-6 col-sm-4">
                            <img src="<%= stage.image %>" class="img-fluid rounded shadow-sm" style="height: 80px; object-fit: cover;">
                            <small class="d-block text-center mt-1 text-muted"><%= stage.name %></small>
                          </div>
                        <% }) %>
                      </div>
                    </div>
                  <% } else { %>
                    <span class="badge bg-secondary mb-3">لا توجد مراحل</span>
                  <% } %> -->

                  <div class="mt-auto d-flex gap-2">
                    <!-- <a href="/admin/projects/edit/<%= p._id %>" class="btn btn-sm flex-fill" style="background-color: #6a72d9;">>تعديل</a> -->
                    <form action="/admin/projects/delete/<%= p._id %>" method="POST" class="delete-form d-inline">
                      <button type="submit" class="btn btn-danger btn-sm flex-fill">حذف</button>
                    </form>
                  </div>
                </div>
              </div>
            </div>
          <% }) %>
        <% } else { %>
          <div class="text-center py-5">
            <i class="fas fa-folder-open fa-5x text-muted"></i>
            <h3 class="mt-4 text-muted">لا توجد مشاريع بعد</h3>
          </div>
        <% } %>
      </div>
    </div>

    <!-- إضافة مشروع جديد -->
    <div id="add-project" class="section">
      <div class="card border-0 shadow-lg">
        <div class="card-header bg-gradient text-white text-center py-4" style="background-color: #1bade2;">
          <h2 class="mb-0">إضافة مشروع جديد</h2>
        </div>
        <div class="card-body p-4 p-md-5">
          <form id="addProjectForm" enctype="multipart/form-data">
            <div class="row g-4">
              <div class="col-lg-8">
                <label class="form-label fw-bold text-primary">عنوان المشروع</label>
                <input type="text" name="title" class="form-control form-control-lg" required>
              </div>
              <div class="col-lg-4">
                <label class="form-label fw-bold text-primary">التصنيف</label>
                <select name="category" class="form-select form-select-lg" required>
                  <option value="">اختر التصنيف</option>
                  <option>مشاريع إنشائية</option>
                  <option>ديكورات داخلية</option>
                </select>
              </div>
              <div class="col-12">
                <label class="form-label fw-bold text-primary">الوصف الكامل</label>
                <textarea name="description" class="form-control" rows="5" required></textarea>
              </div>
              <div class="col-12">
                <label class="form-label fw-bold text-primary">صور المشروع (الأولى رئيسية)</label>
                <input type="file" name="images" multiple accept="image/*" class="form-control form-control-lg" required>
                <div class="image-preview row g-3 mt-3"></div>
              </div>

              <hr class="my-5">

              <div class="col-12">
                <h3 class="text-primary mb-4">مراحل التنفيذ</h3>
                <div id="stages-container">
                  <div class="stage-row row g-3 align-items-end border-bottom pb-4 mb-4">
                    <div class="col-md-6">
                      <input type="text" class="form-control stage-name" placeholder="اسم المرحلة" required>
                    </div>
                    <div class="col-md-5">
                      <input type="file" class="form-control stage-image" accept="image/*" required>
                      <div class="stage-preview mt-2"></div>
                    </div>
                    <div class="col-md-1">
                      <button type="button" class="btn btn-danger remove-stage w-100">حذف</button>
                    </div>
                  </div>
                </div>
                <button type="button" id="add-stage" class="btn btn-outline-success btn-lg px-4 mt-3">
                  إضافة مرحلة جديدة
                </button>
              </div>

              <div class="col-12 text-center mt-5">
                <button type="submit" class="btn btn-lg px-5 shadow-lg" style="background-color: #1bade2;">
                  حفظ المشروع
                </button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- إضافة خبر جديد -->
    <div id="add-news" class="section">
      <div class="card border-0 shadow-lg">
        <div class="card-header bg-gradient text-white text-center py-4" style="background-color: #1bade2;">
          <h2 class="mb-0">إضافة خبر جديد</h2>
        </div>
        <div class="card-body p-4 p-md-5">
          <form id="addNewsForm" enctype="multipart/form-data">
            <div class="row g-4">
              <div class="col-12">
                <label class="form-label fw-bold text-primary">اسم الخبر</label>
                <input type="text" name="title" class="form-control form-control-lg" required>
              </div>
              <div class="col-12">
                <label class="form-label fw-bold text-primary">وصف الخبر</label>
                <textarea name="description" class="form-control" rows="6" required></textarea>
              </div>
              <div class="col-12">
                <label class="form-label fw-bold text-primary">صورة الخبر (اختياري)</label>
                <input type="file" name="image" accept="image/*" class="form-control form-control-lg">
                <div class="image-preview mt-3 text-center"></div>
              </div>
              <div class="col-12 text-center mt-4">
                <button type="submit" class="btn btn-lg px-5 shadow-lg" style="background-color: #1bade2;">
                  حفظ الخبر
                </button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>

<!-- عرض وإدارة الأخبار -->
<div id="news" class="section">
  <div class="card border-0 shadow-lg">
    <div class="card-header bg-gradient text-white text-center py-4" style="background-color: #6a72d9;">
      <h2 class="mb-0">إدارة الأخبار والفعاليات</h2>
    </div>
    <div class="card-body p-4 p-md-5">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h4 class="text-primary mb-0">جميع الأخبار</h4>
        <a href="#" data-section="add-news" class="btn btn-outline-warning">
          إضافة خبر جديد
        </a>
      </div>

      <div class="row g-4" id="news-list">
        <div class="text-center py-5">
          <div class="spinner-border text-primary" style="width: 4rem; height: 4rem;"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// تحميل وعرض الأخبار عند فتح القسم
document.querySelector('a[data-section="news"]').addEventListener('click', loadNews);

async function loadNews() {
  const container = document.getElementById('news-list');
  container.innerHTML = `
    <div class="col-12 text-center py-5">
      <div class="spinner-border text-primary" style="width: 4rem; height: 4rem;"></div>
    </div>`;

  try {
    const res = await fetch('/admin/api/news');
    const data = await res.json();

    if (!data.news || data.news.length === 0) {
      container.innerHTML = `
        <div class="col-12 text-center py-5 text-muted">
          <i class="fas fa-newspaper fa-5x mb-4"></i>
          <h4>لا توجد أخبار حالياً</h4>
          <p>ابدأ بإضافة خبر جديد</p>
        </div>`;
      return;
    }

    container.innerHTML = "";
    data.news.forEach(item => {
      const date = new Date(item.createdAt).toLocaleDateString('ar-EG', {
        year: 'numeric', month: 'long', day: 'numeric'
      });

      container.innerHTML += `
        <div class="col-md-6 col-lg-4">
          <div class="card h-100 shadow-sm">
            ${item.image ? `
              <img src="${item.image}" class="card-img-top" style="height: 200px; object-fit: cover;">
            ` : ''}
            <div class="card-body d-flex flex-column">
              <h5 class="card-title text-primary">${item.title}</h5>
              <p class="text-muted small mb-2"><i class="far fa-calendar"></i> ${date}</p>
              <p class="card-text flex-grow-1">${item.description.substring(0, 100)}...</p>
              <div class="mt-auto d-flex gap-2">
                <button class="btn btn-danger btn-sm flex-fill delete-news" data-id="${item._id}">
                  حذف
                </button>
              </div>
            </div>
          </div>
        </div>`;
    });

  } catch (err) {
    console.error(err);
    container.innerHTML = `<div class="text-danger text-center">فشل تحميل الأخبار</div>`;
  }
}

// حذف خبر
document.getElementById('news-list').addEventListener('click', async function(e) {
  if (e.target.classList.contains('delete-news')) {
    if (!confirm('متأكد من حذف الخبر؟')) return;
    const id = e.target.dataset.id;
    try {
      const res = await fetch(`/admin/api/news/${id}`, { method: 'DELETE' });
      const data = await res.json();
      if (data.success) {
        showToast('تم حذف الخبر بنجاح', 'success');
        loadNews();
      } else {
        showToast('فشل الحذف', 'danger');
      }
    } catch (err) {
      showToast('خطأ في الاتصال', 'danger');
    }
  }
});

// معاينة صورة الخبر
document.querySelector('#add-news input[name="image"]')?.addEventListener('change', function() {
  const preview = document.querySelector('#add-news .image-preview');
  if (this.files[0]) {
    preview.innerHTML = `<img src="${URL.createObjectURL(this.files[0])}" class="img-fluid rounded shadow" style="max-height:300px;">`;
  } else {
    preview.innerHTML = '';
  }
});

// إضافة الخبر (الكود اللي كان ناقص)
document.getElementById('addNewsForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  const formData = new FormData(this);

  try {
    const res = await fetch('/admin/api/news', {
      method: 'POST',
      body: formData
    });
    const data = await res.json();

    if (data.success) {
      showToast('تم إضافة الخبر بنجاح!', 'success');
      this.reset();
      document.querySelector('#add-news .image-preview').innerHTML = '';
      // نروح تلقائي لقسم الأخبار عشان نشوف الخبر الجديد
      document.querySelector('a[data-section="news"]').click();
    } else {
      showToast('خطأ: ' + (data.message || 'فشل إضافة الخبر'), 'danger');
    }
  } catch (err) {
    console.error(err);
    showToast('فشل الإتصال بالسيرفر', 'danger');
  }
});

</script>

    <!-- قسم الموظفين -->
    <div id="employees" class="section">
      <div class="card border-0 shadow-lg">
        <div class="card-header bg-gradient text-white text-center py-4" style="background-color: #1bade2;">
          <h2 class="mb-0">إدارة الموظفين</h2>
        </div>
        <div class="card-body p-4 p-md-5">

          <!-- فورم إضافة موظف -->
          <form id="addEmployeeForm" enctype="multipart/form-data" class="mb-5 p-4 bg-light rounded">
            <h4 class="text-primary mb-4">إضافة موظف جديد</h4>
            <div class="row g-4">
              <div class="col-md-6">
                <label class="form-label fw-bold">اسم الموظف</label>
                <input type="text" name="name" class="form-control form-control-lg" required>
              </div>
              <div class="col-md-6">
                <label class="form-label fw-bold">الوظيفة</label>
                <input type="text" name="jobTitle" class="form-control form-control-lg" placeholder="مثال: مهندس مدني، مصمم داخلي، مدير مشروع..." required>
              </div>
              <div class="col-md-6">
                <label class="form-label fw-bold">رقم الجوال (اختياري)</label>
                <input type="text" name="phone" class="form-control form-control-lg" placeholder="05xxxxxxxx">
              </div>
              <div class="col-md-6">
                <label class="form-label fw-bold">صورة الموظف</label>
                <input type="file" name="image" accept="image/*" class="form-control form-control-lg" required>
                <div class="image-preview mt-3 text-center"></div>
              </div>
              <div class="col-12 text-center">
                <button type="submit" class="btn btn-lg px-5" style="background-color: #6a72d9;">
                  إضافة الموظف
                </button>
              </div>
            </div>
          </form>

          <hr>

          <!-- قائمة الموظفين -->
          <h4 class="text-primary mb-4">الموظفين الحاليين</h4>
          <div class="row g-4" id="employees-container">
            <!-- هتتحمل ديناميكيًا -->
          </div>

        </div>
      </div>
    </div>

  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // تبديل الأقسام
    document.querySelectorAll('.sidebar a[data-section]').forEach(l => {
      l.addEventListener('click', e => {
        e.preventDefault();
        document.querySelectorAll('.sidebar a').forEach(a => a.classList.remove('active'));
        l.classList.add('active');
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.getElementById(l.dataset.section).classList.add('active');
      });
    });

    // Toast
    function showToast(msg, type = 'success') {
      const t = document.createElement('div');
      t.className = `toast align-items-center text-white bg-${type} border-0 position-fixed top-0 start-50 translate-middle-x`;
      t.style = 'z-index: 9999; margin-top: 20px;';
      t.innerHTML = `<div class="d-flex"><div class="toast-body">${msg}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>`;
      document.body.appendChild(t);
      new bootstrap.Toast(t).show();
      setTimeout(() => t.remove(), 5000);
    }

    // إضافة مرحلة
    document.getElementById('add-stage').addEventListener('click', () => {
      const container = document.getElementById('stages-container');
      container.insertAdjacentHTML('beforeend', `
        <div class="stage-row row g-3 align-items-end border-bottom pb-4 mb-4">
          <div class="col-md-6">
            <input type="text" class="form-control stage-name" placeholder="اسم المرحلة" required>
          </div>
          <div class="col-md-5">
            <input type="file" class="form-control stage-image" accept="image/*" required>
            <div class="stage-preview mt-2"></div>
          </div>
          <div class="col-md-1">
            <button type="button" class="btn btn-danger remove-stage w-100">حذف</button>
          </div>
        </div>`);
    });

    // حذف مرحلة
    document.getElementById('stages-container').addEventListener('click', e => {
      if (e.target.closest('.remove-stage') && document.querySelectorAll('.stage-row').length > 1) {
        e.target.closest('.stage-row').remove();
      }
    });

    // معاينة صور المشروع
    document.querySelector('input[name="images"]').addEventListener('change', function() {
      const preview = document.querySelector('.image-preview');
      preview.innerHTML = '';
      Array.from(this.files).forEach(file => {
        const reader = new FileReader();
        reader.onload = e => {
          preview.innerHTML += `<div class="col-4 col-md-3"><img src="${e.target.result}" class="img-fluid rounded shadow"></div>`;
        };
        reader.readAsDataURL(file);
      });
    });

    // معاينة صور المراحل
    document.getElementById('stages-container').addEventListener('change', e => {
      if (e.target.classList.contains('stage-image')) {
        const preview = e.target.closest('.stage-row').querySelector('.stage-preview');
        preview.innerHTML = '';
        if (e.target.files[0]) {
          const reader = new FileReader();
          reader.onload = ev => {
            preview.innerHTML = `<img src="${ev.target.result}" class="img-fluid rounded shadow" style="max-height:150px;">`;
          };
          reader.readAsDataURL(e.target.files[0]);
        }
      }
    });

    // إرسال الفورم - النسخة النهائية المضمونة
    document.getElementById('addProjectForm').addEventListener('submit', async function(e) {
      e.preventDefault();

      const formData = new FormData();

      formData.append('title', this.title.value.trim());
      formData.append('description', this.description.value.trim());
      formData.append('category', this.category.value);

      // صور المشروع
      for (let file of this.images.files) {
        formData.append('images', file);
      }

      // المراحل - اسم الحقل stageImage بدون []
      document.querySelectorAll('.stage-row').forEach((row, index) => {
        const name = row.querySelector('.stage-name').value.trim();
        const file = row.querySelector('.stage-image').files[0];
        if (name && file) {
          formData.append('stageName', name);      // بدون []
          formData.append('stageImage', file);     // بدون []
        }
      });

      try {
        const res = await fetch('/admin/projects/new', {
          method: 'POST',
          body: formData
        });

        const data = await res.json();

        if (data.success) {
          showToast('تم إضافة المشروع والمراحل بنجاح!', 'success');
          this.reset();
          document.querySelector('.image-preview').innerHTML = '';
          document.querySelectorAll('.stage-preview').forEach(p => p.innerHTML = '');
          document.getElementById('stages-container').innerHTML = document.querySelector('.stage-row').outerHTML;
          setTimeout(() => location.reload(), 1500);
        } else {
          showToast('خطأ: ' + (data.error || 'غير معروف'), 'danger');
        }
      } catch (err) {
        console.error(err);
        showToast('خطأ في الاتصال', 'danger');
      }
    });

    // حذف مشروع
    document.addEventListener('submit', async e => {
      if (e.target.classList.contains('delete-form')) {
        e.preventDefault();
        if (!confirm('متأكد من الحذف؟')) return;
        const res = await fetch(e.target.action, { method: 'POST' });
        const data = await res.json();
        if (data.success) {
          e.target.closest('.col-md-6,.col-lg-4,.col-xxl-3').remove();
          showToast('تم الحذف بنجاح', 'success');
        }
      }
    });

// تحميل الموظفين عند فتح القسم
document.querySelector('a[data-section="employees"]').addEventListener('click', () => {
  loadEmployees();
});

async function loadEmployees() {
  try {
    const res = await fetch('/admin/api/employees');
    const data = await res.json();
    const container = document.getElementById('employees-container');
    container.innerHTML = '';

    if (!data.employees || data.employees.length === 0) {
      container.innerHTML = `<div class="col-12 text-center py-5 text-muted">لا يوجد موظفين حالياً</div>`;
      return;
    }

    data.employees.forEach(emp => {
      container.innerHTML += `
        <div class="col-md-6 col-lg-4">
          <div class="card h-100 shadow-sm">
            <img src="${emp.image}" class="card-img-top" style="height: 250px; object-fit: cover;">
            <div class="card-body text-center">
              <h5 class="card-title">${emp.name}</h5>
              <p class="text-primary fw-bold">${emp.jobTitle}</p>
              ${emp.phone ? `<p class="text-muted"><i class="fas fa-phone"></i> ${emp.phone}</p>` : ''}
              <button class="btn btn-danger btn-sm delete-employee" data-id="${emp._id}">
                حذف
              </button>
            </div>
          </div>
        </div>`;
    });
  } catch (err) {
    console.error(err);
  }
}

// معاينة صورة الموظف
document.querySelector('input[name="image"]').addEventListener('change', function() {
  const preview = this.closest('form').querySelector('.image-preview');
  if (this.files[0]) {
    preview.innerHTML = `<img src="${URL.createObjectURL(this.files[0])}" class="img-fluid rounded shadow" style="max-height:200px;">`;
  }
});

// إضافة موظف
document.getElementById('addEmployeeForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  const formData = new FormData(this);

  try {
    const res = await fetch('/admin/api/employees', {
      method: 'POST',
      body: formData
    });
    const data = await res.json();

    if (data.success) {
      showToast('تم إضافة الموظف بنجاح!', 'success');
      this.reset();
      this.querySelector('.image-preview').innerHTML = '';
      loadEmployees();
    } else {
      showToast('خطأ: ' + data.message, 'danger');
    }
  } catch (err) {
    showToast('فشل الإضافة', 'danger');
  }
});

// حذف موظف
document.getElementById('employees-container').addEventListener('click', async function(e) {
  if (e.target.classList.contains('delete-employee')) {
    if (!confirm('متأكد من حذف الموظف؟')) return;
    const id = e.target.dataset.id;
    const res = await fetch(`/admin/api/employees/${id}`, { method: 'DELETE' });
    const data = await res.json();
    if (data.success) {
      showToast('تم الحذف بنجاح', 'success');
      e.target.closest('.col-md-6').remove();
    }
  }
});

// تحميل الإعدادات عند فتح القسم
document.querySelector('a[data-section="contact"]').addEventListener('click', async () => {
  try {
    const res = await fetch('/api/settings');
    const data = await res.json();
    if (data.success) {
      const s = data.settings;
      document.querySelector('#siteSettingsForm [name="siteName"]').value = s.siteName || '';
      document.querySelector('#siteSettingsForm [name="address"]').value = s.address || '';
      document.querySelector('#siteSettingsForm [name="email"]').value = s.email || '';

      // روابط السوشيال
      document.querySelector('[name="facebook"]').value = s.social?.facebook || '';
      document.querySelector('[name="instagram"]').value = s.social?.instagram || '';
      document.querySelector('[name="twitter"]').value = s.social?.twitter || '';
      document.querySelector('[name="tiktok"]').value = s.social?.tiktok || '';
      document.querySelector('[name="whatsapp"]').value = s.social?.whatsapp || '';

      // الأرقام
      const phonesList = document.getElementById('phonesList');
      phonesList.innerHTML = '';
      (s.phones || []).forEach(phone => addPhoneTag(phone));
    }
  } catch (err) { console.error(err); }
});

// إضافة رقم جوال كـ tag
function addPhoneTag(phone) {
  const list = document.getElementById('phonesList');
  const tag = document.createElement('span');
  tag.className = 'badge bg-primary fs-6 px-3 py-2 me-2 mb-2';
  tag.innerHTML = `${phone} <i class="fas fa-times ms-2 cursor-pointer" onclick="this.parentElement.remove(); updatePhonesHidden()"></i>`;
  list.appendChild(tag);
  updatePhonesHidden();
}

// تحديث الحقل المخفي
function updatePhonesHidden() {
  const phones = Array.from(document.querySelectorAll('#phonesList span')).map(span => span.textContent.trim().replace('×', ''));
  document.getElementById('phonesHidden').value = phones.join(',');
}

// إضافة رقم عند الضغط على Enter
document.getElementById('phoneInput').addEventListener('keydown', e => {
  if (e.key === 'Enter') {
    e.preventDefault();
    const val = e.target.value.trim();
    if (val && /^\d{10,15}$/.test(val.replace(/\D/g,''))) {
      addPhoneTag(val);
      e.target.value = '';
    }
  }
});

// حفظ الإعدادات
document.getElementById('siteSettingsForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  const formData = new FormData(this);
  const phones = document.getElementById('phonesHidden').value.split(',').filter(p => p);
  formData.set('phones', JSON.stringify(phones));

  try {
    const res = await fetch('/api/settings', {
      method: 'POST',
      body: formData
    });
    const data = await res.json();
    if (data.success) {
      showToast('تم حفظ إعدادات الموقع بنجاح!', 'success');
    } else {
      showToast('خطأ: ' + data.message, 'danger');
    }
  } catch (err) {
    showToast('فشل الحفظ', 'danger');
  }
});

  </script>
</body>
</html>