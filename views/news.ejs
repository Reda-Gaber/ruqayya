<%- include("parts/head.ejs") %> 
<%- include("parts/header.ejs") %>

<section class="page-header">
  <div class="container">
    <h1>الأخبار</h1>
    <p>تابع أحدث أخبارنا وفعالياتنا ومشاريعنا</p>
  </div>
</section>

<section class="news">
  <div class="container">
    <!-- Loading State -->
    <div id="newsLoading" class="text-center py-5">
      <div style="display: inline-block; width: 50px; height: 50px; border: 4px solid #f3f3f3; border-top: 4px solid #1bade2; border-radius: 50%; animation: spin 1s linear infinite;"></div>
      <p style="margin-top: 1rem; color: #6C6C70;">جاري تحميل الأخبار...</p>
    </div>
    <style>
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
    </style>

    <!-- News Grid Container -->
    <div id="newsGrid" class="news-grid" style="display: none;"></div>

    <!-- Empty State -->
    <div id="newsEmpty" class="text-center py-5" style="display: none;">
      <p class="text-muted">لا توجد أخبار متاحة حالياً</p>
    </div>

    <!-- Error State -->
    <div id="newsError" class="text-center py-5" style="display: none;">
      <p class="text-danger">حدث خطأ في تحميل الأخبار. يرجى المحاولة مرة أخرى.</p>
    </div>
  </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', async function() {
  const newsGrid = document.getElementById('newsGrid');
  const newsLoading = document.getElementById('newsLoading');
  const newsEmpty = document.getElementById('newsEmpty');
  const newsError = document.getElementById('newsError');

  try {
    // Fetch news from API
    const response = await fetch('/api/news');
    const data = await response.json();

    // Hide loading
    newsLoading.style.display = 'none';

    // Check if request was successful and news array exists
    if (data.success && Array.isArray(data.news) && data.news.length > 0) {
      // Clear any previous content
      newsGrid.innerHTML = '';

      // Render each news item
      data.news.forEach(function(item) {
        const newsCard = document.createElement('article');
        newsCard.className = 'news-card';

        // Image section
        let imageHTML = '';
        if (item.image && item.image.trim() !== '') {
          imageHTML = `
            <div class="news-image">
              <img
                src="${item.image}"
                alt="${item.title || 'خبر'}"
                loading="lazy"
                onerror="this.parentElement.style.display='none'"
              />
            </div>
          `;
        } else {
          imageHTML = `
            <div class="news-image" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center;">
              <i class="fas fa-newspaper" style="font-size: 3rem; color: white; opacity: 0.7;"></i>
            </div>
          `;
        }

        // Date formatting
        let dateHTML = 'تاريخ غير محدد';
        if (item.createdAt) {
          try {
            const date = new Date(item.createdAt);
            if (!isNaN(date.getTime())) {
              dateHTML = date.toLocaleDateString('ar-SA', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
              });
            }
          } catch (e) {
            console.error('Date parsing error:', e);
          }
        }

        // Description truncation
        const desc = (item.description || '').trim();
        const truncated = desc.length > 150 ? desc.substring(0, 150) + '...' : desc;

        // Build card HTML
        newsCard.innerHTML = `
          ${imageHTML}
          <div class="news-content">
            <div class="news-meta">
              <span class="news-date">${dateHTML}</span>
            </div>
            <h3>${item.title || 'بدون عنوان'}</h3>
            <p>${truncated}</p>
            <a href="/news/${item._id}" class="news-link">اقرأ المزيد ←</a>
          </div>
        `;

        newsGrid.appendChild(newsCard);
        
        // Lazy load images after append
        const img = newsCard.querySelector('img');
        if (img && 'loading' in HTMLImageElement.prototype) {
          img.loading = 'lazy';
        }
      });

      // Show news grid
      newsGrid.style.display = 'grid';
    } else {
      // No news available
      newsEmpty.style.display = 'block';
    }
  } catch (error) {
    console.error('Error fetching news:', error);
    newsLoading.style.display = 'none';
    newsError.style.display = 'block';
  }
});
</script>

<%- include("parts/footer.ejs") %>